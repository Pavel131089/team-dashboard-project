var B=Object.defineProperty,M=Object.defineProperties;var O=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var L=(r,s,a)=>s in r?B(r,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[s]=a,C=(r,s)=>{for(var a in s||(s={}))P.call(s,a)&&L(r,a,s[a]);if(A)for(var a of A(s))$.call(s,a)&&L(r,a,s[a]);return r},b=(r,s)=>M(r,O(s));import{j as e,C as k,a as G,B as J,b as H,c as K,d as V}from"./ui-CBbhuu0b.js";import{r as o,u as R}from"./vendor-DxaywbHF.js";import{A as I,a as D,b as U}from"./alert-FLBE-qXf.js";import{L as p,I as T,R as q,a as F}from"./radio-group-DThqyodC.js";import{I as z}from"./icon-CeCB3gnH.js";import{s as h,u as j,a as E}from"./index-qiOd5fLb.js";import"./index-DQjIwgLJ.js";const Q=({message:r})=>e.jsxs(I,{variant:"destructive",children:[e.jsx(z,{name:"AlertTriangle",className:"h-4 w-4"}),e.jsx(D,{children:"Ошибка"}),e.jsx(U,{children:r})]}),W=()=>e.jsxs("div",{className:"pt-2 text-sm text-slate-500",children:[e.jsx("p",{children:"Для демо-доступа используйте:"}),e.jsxs("ul",{className:"list-disc pl-5 mt-1 space-y-1",children:[e.jsxs("li",{children:["Руководитель:"," ",e.jsx("span",{className:"font-medium",children:"manager / manager123"})]}),e.jsxs("li",{children:["Сотрудник: ",e.jsx("span",{className:"font-medium",children:"employee / employee123"})]})]})]}),X=({formData:r,error:s,onInputChange:a,onRoleChange:m,onSubmit:c})=>e.jsxs("form",{onSubmit:c,children:[e.jsxs(k,{className:"space-y-4",children:[s&&e.jsx(Q,{message:s}),e.jsx(Y,{value:r.username,onChange:a}),e.jsx(Z,{value:r.password,onChange:a}),e.jsx(_,{value:r.role,onChange:m}),e.jsx(W,{})]}),e.jsx(G,{children:e.jsx(J,{type:"submit",className:"w-full",children:"Войти"})})]}),Y=({value:r,onChange:s})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"username",children:"Имя пользователя"}),e.jsx(T,{id:"username",name:"username",placeholder:"Введите имя пользователя",value:r,onChange:s})]}),Z=({value:r,onChange:s})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{htmlFor:"password",children:"Пароль"}),e.jsx(T,{id:"password",name:"password",type:"password",placeholder:"Введите пароль",value:r,onChange:s})]}),_=({value:r,onChange:s})=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(p,{children:"Выберите роль"}),e.jsxs(q,{value:r,onValueChange:s,className:"flex space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{value:"manager",id:"manager"}),e.jsx(p,{htmlFor:"manager",children:"Руководитель"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(F,{value:"employee",id:"employee"}),e.jsx(p,{htmlFor:"employee",children:"Сотрудник"})]})]})]}),ee={login(r){try{if(console.log("Попытка входа:",r),j.initializeDefaultUsers(),this.isDefaultUser(r)){console.log("Обнаружен вход со стандартными учетными данными");const a=this.createDefaultUserFromCredentials(r);return this.createUserSession(a),{success:!0,user:a}}const s=this.findUserByCredentials(r);return s?(this.createUserSession(s),console.log("Успешный вход:",s.name,s.role),{success:!0,user:s}):{success:!1,error:"Неверное имя пользователя или пароль"}}catch(s){return console.error("Ошибка при авторизации:",s),{success:!1,error:"Произошла ошибка при входе в систему"}}},isDefaultUser(r){const{username:s,password:a,role:m}=r;return s==="manager"&&a==="manager123"&&m==="manager"||s==="employee"&&a==="employee123"&&m==="employee"},createDefaultUserFromCredentials(r){const{username:s,password:a,role:m}=r;return{id:s==="manager"?"default-manager":"default-employee",name:s==="manager"?"Менеджер":"Сотрудник",email:s,password:a,role:m}},findUserByCredentials(r){console.log("Поиск пользователя по учетным данным:",r);const{username:s,password:a,role:m}=r,c=j.getUsersFromStorage();if(console.log("Пользователи в хранилище:",c.length),!Array.isArray(c))return console.warn("Хранилище пользователей повреждено, инициализируем заново"),j.initializeDefaultUsers(),null;for(const n of c){const g=n.email&&n.email.toLowerCase()===s.toLowerCase(),d=n.name&&n.name.toLowerCase()===s.toLowerCase();if((g||d)&&n.password===a&&n.role===m)return console.log("Найден пользователь:",n.name),n}return console.log("Пользователь не найден"),null},createUserSession(r){const s={id:r.id,username:r.name,role:r.role,isAuthenticated:!0,loginTime:new Date().toISOString()};h.saveSession(s),localStorage.getItem("projects")||localStorage.setItem("projects",JSON.stringify([])),console.log("Создана сессия пользователя:",s)}};function se(r){const[s,a]=o.useState({username:"",password:"",role:"manager"}),[m,c]=o.useState(null),n=R(),g=o.useCallback(l=>{const{name:i,value:u}=l.target;a(t=>b(C({},t),{[i]:u}))},[]),d=o.useCallback(l=>{a(i=>b(C({},i),{role:l}))},[]),x=o.useCallback(l=>{n(l==="manager"?"/dashboard":"/employee")},[n,r]),S=o.useCallback(()=>{try{j.initializeDefaultUsers();const l=h.getCurrentSession();if(l&&l.isAuthenticated)return{authenticated:!0,role:l.role};const i=h.getErrorMessage();return i&&c(i),{authenticated:!1,role:null}}catch(l){return console.error("Ошибка при проверке сессии:",l),h.clearSession(),{authenticated:!1,role:null}}},[]),y=o.useCallback(l=>{if(l.preventDefault(),c(null),!s.username.trim()||!s.password.trim()){c("Пожалуйста, заполните все поля");return}try{console.log("Отправка формы авторизации:",s);const i=C({},s),u=ee.login(i);u.success&&u.user?(console.log("Успешный вход:",u.user),setTimeout(()=>{E.success(`Добро пожаловать, ${u.user.name}!`,{duration:3e3}),x(u.user.role)},0)):(console.error("Ошибка входа:",u.error),c(u.error||"Произошла ошибка при входе"))}catch(i){console.error("Ошибка авторизации:",i),c("Произошла непредвиденная ошибка при входе. Попробуйте позже.")}},[s,x]),v=o.useCallback(()=>{j.initializeDefaultUsers(),localStorage.getItem("projects")||localStorage.setItem("projects",JSON.stringify([]))},[]),w=o.useCallback(()=>h.getCurrentSession(),[]),N=o.useCallback(()=>{h.clearSession(),setTimeout(()=>{E.success("Вы успешно вышли из системы"),n("/login")},0)},[n]);return{formData:s,error:m,handleInputChange:g,handleRoleChange:d,handleSubmit:y,checkExistingSession:S,initializeDefaultUsers:v,checkUserAuth:w,logout:N,setError:c}}const ue=()=>{const r=R(),[s,a]=o.useState(!1),[m,c]=o.useState({}),[n,g]=o.useState(null),[d,x]=o.useState(!0),{formData:S,error:y,handleInputChange:v,handleRoleChange:w,handleSubmit:N,checkExistingSession:l,initializeDefaultUsers:i}=se();o.useEffect(()=>{try{const t="test-storage-login";localStorage.setItem(t,"test"),localStorage.removeItem(t),x(!0),console.log("LocalStorage доступен")}catch(t){console.error("LocalStorage недоступен:",t),x(!1),g("LocalStorage недоступен. Проверьте настройки браузера.")}},[]),o.useEffect(()=>{try{console.log("Инициализация данных на странице входа");const t={url:window.location.href,path:window.location.pathname,userAgent:navigator.userAgent,time:new Date().toISOString()};c(t),console.log("Диагностическая информация:",t),d&&i()}catch(t){console.error("Ошибка при инициализации данных:",t),g(`Ошибка инициализации: ${t.message}`)}},[i,d]),o.useEffect(()=>{if(d)try{console.log("Проверка существующей сессии...");const t=l();if(console.log("Результат проверки сессии:",t),t.authenticated&&t.role){a(!0);const f=t.role==="manager"?"/dashboard":"/employee";console.log("Перенаправление на",f),setTimeout(()=>{r(f,{replace:!0})},10)}else console.log("Активная сессия не найдена, показываем форму входа")}catch(t){console.error("Ошибка при проверке сессии:",t),g(`Ошибка проверки сессии: ${t.message}`)}},[l,r,d]);const u=t=>{t.preventDefault(),console.log("Отправка формы входа",S);try{N(t)}catch(f){console.error("Ошибка при отправке формы:",f),g(`Ошибка входа: ${f.message}`)}};return s?e.jsx("div",{className:"flex min-h-screen items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-4",children:e.jsx(z,{name:"Loader2",className:"h-8 w-8 animate-spin text-primary mx-auto"})}),e.jsx("div",{className:"text-gray-500",children:"Перенаправление..."})]})}):e.jsx("div",{className:"flex min-h-screen items-center justify-center bg-gray-100 p-4",children:e.jsxs(H,{className:"w-full max-w-md",children:[e.jsx(K,{className:"text-center",children:e.jsx(V,{className:"text-2xl",children:"Вход в систему"})}),e.jsxs(k,{children:[(n||y)&&e.jsxs(I,{variant:"destructive",className:"mb-4",children:[e.jsx(D,{children:"Ошибка"}),e.jsx(U,{children:n||y})]}),!d&&e.jsxs(I,{className:"mb-4",children:[e.jsx(D,{children:"Проблема с хранилищем"}),e.jsx(U,{children:"LocalStorage недоступен, что может вызвать проблемы с работой приложения. Проверьте настройки приватности браузера."})]}),e.jsx(X,{formData:S,error:null,onInputChange:v,onRoleChange:w,onSubmit:u}),!1]})]})})};export{ue as default};
//# sourceMappingURL=Login-BXBoyeqF.js.map
